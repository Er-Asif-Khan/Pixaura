<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comic Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a1a, #2b2b2b);
      color: #f1f1f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }
    h2 {
      margin-bottom: 15px;
      font-size: 2rem;
      color: #ffcc00;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.5);
    }

    /* Form Styling */
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      justify-content: center;
    }
    input[type="file"], select, button {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    input[type="file"] {
      background: #333;
      color: #fff;
    }
    select {
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    button {
      background: #ffcc00;
      color: #1a1a1a;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #ffdb4d;
    }

    /* Comic Container */
    #comicContainer {
      position: relative;
      display: inline-block;
      margin-top: 20px;
      max-width: 100%;
    }
    #bubblesLayer{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #previewImage {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    /* Bubble Styling */
    .bubble {
      position: absolute;
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-position: center;
      
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-align: center;
      color: #000;
      max-width: 200px;
      min-width: 80px;
      min-height: 60px;
      width: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      overflow: hidden;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
      z-index: 10;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
      line-height: 1.2em;
    }

    .bubble.left {
      background-image: url('/static/Image_ComicGen/bubble_left.png');
      padding: 25px 35px 30px 25px;
    }

    .bubble.right {
      background-image: url('/static/Image_ComicGen/bubble_right.png');
      padding: 25px 25px 30px 38px;
      
    }

    /* Download Button */
    #downloadBtn {
      margin-top: 20px;
      padding: 12px 25px;
      font-size: 1rem;
      background: #28a745;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      display: none;
      transition: background 0.3s;
    }
    #downloadBtn:hover {
      background: #34d058;
    }

    /* Responsive */
    @media (max-width: 600px) {
      form {
        flex-direction: column;
        align-items: stretch;
      }
      h2 {
        font-size: 1.6rem;
      }
      .bubble {
        font-size: 0.9rem !important;
      }
    }
  </style>
</head>
<body>
  <h2>Comic Bubble Generator</h2>

  <form action = "./comicgen" id="comicForm" method="post" enctype="multipart/form-data">
    <input type="file" name="image" id="imageInput" accept="image/*" required />
    <select name="genre" id="genre">
      <option value="Comedy">Comedy</option>
      <option value="Horror">Horror</option>
      <option value="Drama">Drama</option>
      <option value="Romance">Romance</option>
      <option value="Sci-Fi">Sci-Fi</option>
    </select>
    <button type="submit">Generate</button>
  </form>

  <div id="comicContainer" style="position: relative; display: inline-block;">
    <img id="previewImage" />
    <div id="bubblesLayer"></div>
  </div>

  <canvas id="comicCanvas" style="display:none;"></canvas>
  <button id="downloadBtn" style="display:none;">Download Comic</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    function adjustBubble(bubble, head, imgWidth, imgHeight, scaleX, scaleY, isLeft) {
      let bw = head.bubble_width * scaleX;
      let bh = bw;
      let fontSize = head.font_size;

      let x, y;
      if (isLeft) {
        x = head.top_l[0] * scaleX - bw;
        y = head.top_l[1] * scaleY - (bw * 0.6);
      } else {
        const topRightX = head.bottom_r[0];
        const topRightY = head.top_l[1];
        x = topRightX * scaleX;
        y = topRightY * scaleY - (bw * 0.6);
      }

      let tries = 0;
      while (tries < 50) {
        let overlapsHead = !(x + bw < head.top_l[0] * scaleX || x > head.bottom_r[0] * scaleX || y + bh < head.top_l[1] * scaleY || y > head.bottom_r[1] * scaleY);
        
        let touchesEdge = false;

        if (isLeft) {
          if (x < 0) { touchesEdge = true; x += 5; }
          if (y < 0) { touchesEdge = true; y += 5; }
          if (overlapsHead) {
            if (x + bw > head.top_l[0] * scaleX) x -= 5;
            if (y + bh > head.top_l[1] * scaleY) y -= 5;
          }
        } else {
          if (x + bw > imgWidth) { touchesEdge = true; x -=5; }
          if (y < 0) { touchesEdge = true; y += 5; }
          if (overlapsHead) {
            if (x < head.bottom_r[0] * scaleX) x += 5;
            if (y + bh > head.top_l[1] * scaleY) y -= 5;
          }
        }

        if (touchesEdge && overlapsHead) {
          bw *= 0.9;
          bh = bw;
          fontSize *= 0.9;
        }

        if (!overlapsHead && x >= 0 && y >= 0 && x + bw <= imgWidth && y + bh <= imgHeight) break;

        tries++;
      }

      bubble.style.left = x + "px";
      bubble.style.top = y + "px";
      // bubble.style.width = (bw * 2) + "px";
      bubble.style.fontSize = (fontSize * 1.15) + "px";
    }

    document.getElementById('comicForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData();
    const fileInput = document.getElementById('imageInput');
    const genre = document.getElementById('genre').value;

    if (!fileInput.files.length) return alert("Please select an image");

    formData.append('image', fileInput.files[0]);
    formData.append('genre', genre);

    fetch('./comicgen', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        const previewImage = document.getElementById('previewImage');
        const bubblesLayer = document.getElementById('bubblesLayer');
        const downloadBtn = document.getElementById('downloadBtn');

        // Load the uploaded image into preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;

          previewImage.onload = function() {
            bubblesLayer.innerHTML = ""; // Clear old bubbles
            
            const imgWidth = previewImage.width;
            const imgHeight = previewImage.height;
            const scaleX = imgWidth / data.original_width;
            const scaleY = imgHeight / data.original_height;

            data.heads.forEach((headData, index) => {
              const bubble = document.createElement('div');
              bubble.classList.add('bubble');

              bubble.classList.add(index === 0 ? 'left' : 'right');

              bubble.textContent = headData.text;
            
              bubblesLayer.appendChild(bubble);

              adjustBubble(bubble, headData, imgWidth, imgHeight, scaleX, scaleY, index === 0);
            });

            // Show download button
            downloadBtn.style.display = "inline-block";
          };
        };
        reader.readAsDataURL(fileInput.files[0]);
      })
      .catch(err => {
        console.error(err);
        alert("Error generating comic bubbles");
      });
  });

  // Download using html2canvas
  document.getElementById('downloadBtn').addEventListener('click', function() {
    const container = document.getElementById('comicContainer');
    html2canvas(container, { backgroundColor: null }).then(canvas => {
      const link = document.createElement('a');
      link.download = "comic_image.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  });
  </script>
</body>
</html>